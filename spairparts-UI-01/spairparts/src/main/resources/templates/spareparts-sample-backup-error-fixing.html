<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Spare Parts Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db',
                        secondary: '#2c3e50',
                        accent: '#e74c3c',
                        success: '#27ae60',
                        warning: '#f39c12',
                        purple: '#9b59b6'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulseGlow {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(231, 76, 60, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
        }
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Loading States */
        .loading {
            position: relative;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        /* Search highlighting */
        .search-results-highlight {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Custom animations for the dashboard */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600">
    <!-- Mobile Menu Button -->
    <button id="mobile-menu-button" class="fixed top-4 left-4 z-50 md:hidden bg-gray-800 text-white p-3 rounded-lg shadow-lg hover:bg-gray-700 transition-all duration-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

    <!-- Main Container -->
    <div class="flex min-h-screen">
        <!-- Responsive Sidebar -->
        <div id="sidebar" class="fixed md:relative transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40 w-72 bg-gradient-to-b from-gray-800 via-gray-900 to-black text-white shadow-2xl h-full overflow-y-auto">
            <div class="p-6">
                <!-- Sidebar Header -->
                <div class="mb-8 text-center relative">
                    <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        Dashboard
                    </h2>
                    <!-- Close button for mobile -->
                    <button id="close-mobile-menu" class="absolute top-0 right-0 md:hidden text-white hover:text-gray-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- User Info Section -->
                <div class="mb-6 p-4 bg-gray-700/50 rounded-xl">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-sm" th:text="${username != null ? #strings.substring(username, 0, 1) : 'U'}">U</span>
                        </div>
                        <div>
                            <div class="text-white font-semibold text-sm" th:text="${username ?: 'User'}">User</div>
                            <div class="text-gray-300 text-xs" th:text="${userRole ?: 'USER'}">USER</div>
                            <span th:if="${isAdmin}" class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">ADMIN</span>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation -->
                <nav class="space-y-3">
                    <div class="nav-item active bg-gradient-to-r from-primary to-purple text-white px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg" data-section="overview">
                        <div class="flex items-center space-x-3">
                            <span>üìä</span>
                            <span class="font-medium">Overview</span>
                        </div>
                    </div>
                    <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="items">
                        <div class="flex items-center space-x-3">
                            <span>üì¶</span>
                            <span class="font-medium">Items</span>
                            <span id="items-count-badge" class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                    </div>
                    <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="analytics">
                        <div class="flex items-center space-x-3">
                            <span>üìà</span>
                            <span class="font-medium">Analytics</span>
                        </div>
                    </div>
                    <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="settings">
                        <div class="flex items-center space-x-3">
                            <span>‚öôÔ∏è</span>
                            <span class="font-medium">Settings</span>
                        </div>
                    </div>
                    
                    <!-- Admin Only Section -->
                    <div sec:authorize="hasRole('ADMIN')" class="border-t border-gray-600 pt-4 mt-4">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-3 px-4">Admin Tools</div>
                        <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="admin">
                            <div class="flex items-center space-x-3">
                                <span>üîê</span>
                                <span class="font-medium">Admin Panel</span>
                            </div>
                        </div>
                        <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="users">
                            <div class="flex items-center space-x-3">
                                <span>üë•</span>
                                <span class="font-medium">User Management</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="border-t border-gray-600 pt-4 mt-4">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-3 px-4">Quick Actions</div>
                        <button id="quick-add-item" class="w-full nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-green-600 hover:scale-105 bg-green-500 text-white mb-2">
                            <div class="flex items-center space-x-3">
                                <span>‚ûï</span>
                                <span class="font-medium">Add Item</span>
                            </div>
                        </button>
                        <button id="quick-search" class="w-full nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-blue-600 hover:scale-105 bg-blue-500 text-white">
                            <div class="flex items-center space-x-3">
                                <span>üîç</span>
                                <span class="font-medium">Search Items</span>
                            </div>
                        </button>
                    </div>
                    
                    <hr class="my-6 border-gray-600">
                    
                    <!-- Logout Button -->
                    <div class="nav-item logout bg-gradient-to-r from-accent to-red-600 px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg" onclick="logout()">
                        <div class="flex items-center space-x-3">
                            <span>üö™</span>
                            <span class="font-medium">Logout</span>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
          <!-- Main Content Area - Responsive -->
        <div class="flex-1 md:ml-0 p-4 md:p-8 bg-white/95 backdrop-blur-sm overflow-y-auto min-h-screen">
            <!-- Header - Mobile Responsive -->
            <div class="bg-white rounded-2xl p-4 md:p-8 mb-6 md:mb-8 shadow-xl border border-white/50">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div class="mb-6 lg:mb-0">
                        <h1 class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-primary to-purple bg-clip-text text-transparent mb-2">
                            Spare Parts Dashboard
                        </h1>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4 text-sm text-gray-600">
                            <div class="bg-gray-100 px-4 py-2 rounded-full font-semibold">
                                Welcome, <span id="username-display" th:text="${username ?: 'User'}">User</span>!
                                <span th:if="${isAdmin}" class="ml-2 bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-bold">ADMIN</span>
                            </div>
                            <div class="text-xs sm:text-sm">Last Updated: <span id="last-updated" class="font-semibold"></span></div>
                            <div class="flex items-center gap-2">
                                <div id="db-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                                <span id="db-status-text" class="text-xs">Connecting...</span>
                            </div>
                        </div>
                    </div>                    
                    <!-- Search Container - Mobile Responsive -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" 
                               id="search-bar" 
                               placeholder="üîç Search items by name, description, or ID..."
                               class="px-4 md:px-6 py-3 border-2 border-gray-200 rounded-full focus:border-primary focus:ring-0 focus:outline-none transition-all duration-300 text-sm w-full sm:w-80">
                        
                        <div class="flex gap-2">
                            <button id="search-button" 
                                    class="bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white px-4 md:px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl text-sm">
                                üîç <span class="hidden sm:inline">Search</span>
                            </button>
                            <button id="clear-search-button" 
                                    class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 md:px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 text-sm">
                                ‚úñ <span class="hidden sm:inline">Clear</span>
                            </button>
                            <button class="md:hidden bg-gradient-to-r from-accent to-red-600 hover:from-red-600 hover:to-accent text-white px-4 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 text-sm" onclick="logout()">
                                üö™
                            </button>
                            <button class="bg-gradient-to-r from-accent to-red-600 hover:from-red-600 hover:to-accent text-white px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 text-sm" onclick="logout()">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider mb-4">Total Items</h3>
                    <div class="text-4xl font-black bg-gradient-to-r from-primary to-purple bg-clip-text text-transparent" id="total-items">0</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider mb-4">Total Value</h3>
                    <div class="text-4xl font-black bg-gradient-to-r from-success to-green-600 bg-clip-text text-transparent" id="total-value">0</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider mb-4">Low Stock Items</h3>
                    <div class="text-4xl font-black bg-gradient-to-r from-accent to-red-600 bg-clip-text text-transparent" id="low-stock">0</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider mb-4">Average Price</h3>
                    <div class="text-4xl font-black bg-gradient-to-r from-warning to-yellow-600 bg-clip-text text-transparent" id="avg-price">0</div>
                </div>
            </div>
            
            <!-- Search Results Message -->
            <div id="search-results-container"></div>
            
            <!-- Items Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="items-container">
                <!-- Items will be rendered here -->
            </div>
            
            <!-- Add Item Form -->
            <div class="bg-white rounded-2xl p-8 shadow-xl border border-white/50 mb-8">
                <h2 class="text-2xl font-bold text-center text-secondary mb-8">üì¶ Add New Item to Stock</h2>
                <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="text" 
                           id="item-name" 
                           placeholder="Item Name" 
                           required 
                           class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                    
                    <input type="text" 
                           id="item-description" 
                           placeholder="Item Description" 
                           required 
                           class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                    
                    <input type="number" 
                           id="item-price" 
                           placeholder="Price" 
                           step="0.01" 
                           min="0" 
                           required 
                           class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                      <input type="number" 
                           id="item-quantity" 
                           placeholder="Quantity" 
                           min="1" 
                           required 
                           class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">                    <select id="item-currency" 
                            class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                        <option value="LKR">LKR (Sri Lankan Rupee)</option>
                        <option value="USD">USD (US Dollar)</option>
                        <option value="EUR">EUR (Euro)</option>
                        <option value="GBP">GBP (British Pound)</option>
                    </select>
                      <div class="flex gap-2">
                        <input type="url" 
                               id="item-image" 
                               placeholder="Image URL (optional)" 
                               class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                        <button type="button" 
                                id="load-image-btn" 
                                onclick="loadImagePreview()" 
                                class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold transition-colors duration-300">
                            üñºÔ∏è Preview
                        </button>
                    </div>
                    
                    <!-- Image Preview Area -->
                    <div id="image-preview-container" class="md:col-span-2 hidden">
                        <div class="bg-gray-50 rounded-xl p-4 text-center">
                            <p class="text-sm text-gray-600 mb-2">Image Preview:</p>
                            <img id="image-preview" 
                                 src="" 
                                 alt="Image preview" 
                                 class="max-w-full max-h-32 mx-auto rounded-lg shadow-md"
                                 style="display: none;">
                            <div id="image-error" class="text-red-500 text-sm hidden">
                                ‚ùå Failed to load image. Please check the URL.
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit"
                            class="md:col-span-2 bg-gradient-to-r from-success to-green-600 hover:from-green-600 hover:to-success text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                        Add Item to Stock
                    </button>
                </form>
            </div>
            
            <!-- Analytics Section -->
            <div id="analytics-section" class="hidden bg-white rounded-2xl p-8 shadow-xl border border-white/50">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-secondary">üìà Analytics & Future Insights</h2>
                </div>
                
                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-50 rounded-xl p-6 text-center shadow-lg">
                        <h3 class="text-lg font-bold text-secondary mb-4 uppercase tracking-wider">Stock Distribution</h3>
                        <canvas id="stockChart" width="300" height="200" class="max-w-full"></canvas>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 text-center shadow-lg">
                        <h3 class="text-lg font-bold text-secondary mb-4 uppercase tracking-wider">Price Analysis</h3>
                        <canvas id="priceChart" width="300" height="200" class="max-w-full"></canvas>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 text-center shadow-lg">
                        <h3 class="text-lg font-bold text-secondary mb-4 uppercase tracking-wider">Inventory Trends</h3>
                        <canvas id="trendChart" width="300" height="200" class="max-w-full"></canvas>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 text-center shadow-lg">
                        <h3 class="text-lg font-bold text-secondary mb-4 uppercase tracking-wider">Reorder Recommendations</h3>
                        <canvas id="reorderChart" width="300" height="200" class="max-w-full"></canvas>
                    </div>
                </div>
                
                <!-- Insights Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                    <div class="bg-red-50 border-l-4 border-accent p-6 rounded-lg shadow-lg">
                        <h4 class="text-lg font-bold text-secondary mb-4">üö® Critical Actions Required</h4>
                        <div id="critical-content" class="text-sm text-gray-700">Loading insights...</div>
                    </div>
                    <div class="bg-yellow-50 border-l-4 border-warning p-6 rounded-lg shadow-lg">
                        <h4 class="text-lg font-bold text-secondary mb-4">‚ö†Ô∏è Attention Needed</h4>
                        <div id="warning-content" class="text-sm text-gray-700">Loading insights...</div>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-primary p-6 rounded-lg shadow-lg">
                        <h4 class="text-lg font-bold text-secondary mb-4">üí° Strategic Recommendations</h4>
                        <div id="recommendation-content" class="text-sm text-gray-700">Loading insights...</div>
                    </div>
                    <div class="bg-purple-50 border-l-4 border-purple p-6 rounded-lg shadow-lg">
                        <h4 class="text-lg font-bold text-secondary mb-4">üîÆ Future Predictions</h4>
                        <div id="forecast-content" class="text-sm text-gray-700">Loading insights...</div>
                    </div>
                </div>
            </div>
        </div>    </div>
      <script>        // Store admin status from server
        const isAdmin = [[${isAdmin}]] || false;
        const currentUser = '[[${username}]]' || 'User';
        const userRole = '[[${userRole}]]' || 'USER';
        
        // Admin status should no longer be forced as testing is complete
        const isAdminForced = false;
        
        // Debug logging
        console.log('üîí Admin Status Debug:');
        console.log('- isAdmin (from server):', isAdmin, '(type:', typeof isAdmin, ')');
        console.log('- isAdminForced:', isAdminForced);
        console.log('- currentUser:', currentUser);
        console.log('- userRole:', userRole);
          // Add visual debug indicator to page (bottom left)
        setTimeout(() => {
            const debugDiv = document.createElement('div');
            debugDiv.style.position = 'fixed';
            debugDiv.style.bottom = '20px';
            debugDiv.style.left = '20px';
            debugDiv.style.backgroundColor = isAdminForced ? 'green' : (isAdmin ? 'blue' : 'red');
            debugDiv.style.color = 'white';
            debugDiv.style.padding = '12px';
            debugDiv.style.borderRadius = '8px';
            debugDiv.style.zIndex = '9999';
            debugDiv.style.fontSize = '12px';
            debugDiv.style.fontFamily = 'monospace';
            debugDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            debugDiv.style.border = '2px solid rgba(255,255,255,0.2)';
            debugDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">üîç DEBUG INFO</div>
                <div>Admin: ${isAdmin ? '‚úÖ' : '‚ùå'} (${isAdmin})</div>
                <div>User: ${currentUser}</div>
                <div>Role: ${userRole}</div>
                <div style="margin-top: 4px; font-size: 10px; opacity: 0.8;">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            document.body.appendChild(debugDiv);
        }, 1000);
        
        // Mobile Menu Functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileMenu();
            initializeQuickActions();
            updateItemsCount();
        });

        function initializeMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            const closeMobileMenu = document.getElementById('close-mobile-menu');

            function openMobileMenu() {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                console.log('üì± Mobile menu opened');
            }

            function closeMobileMenuFunc() {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
                console.log('üì± Mobile menu closed');
            }

            // Event listeners
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', openMobileMenu);
            }

            if (closeMobileMenu) {
                closeMobileMenu.addEventListener('click', closeMobileMenuFunc);
            }

            if (overlay) {
                overlay.addEventListener('click', closeMobileMenuFunc);
            }

            // Close mobile menu when nav item is clicked (mobile only)
            const navItems = document.querySelectorAll('.nav-item:not(.logout):not(button)');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth < 768) { // Only on mobile
                        closeMobileMenuFunc();
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) { // Desktop size
                    closeMobileMenuFunc();
                }
            });

            // ESC key to close mobile menu
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && window.innerWidth < 768) {
                    closeMobileMenuFunc();
                }
            });
        }

        function initializeQuickActions() {
            // Quick Add Item button
            const quickAddButton = document.getElementById('quick-add-item');
            if (quickAddButton) {
                quickAddButton.addEventListener('click', () => {
                    // Scroll to add item form
                    const addForm = document.getElementById('add-item-form');
                    if (addForm) {
                        addForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Focus on first input
                        const firstInput = addForm.querySelector('input');
                        if (firstInput) {
                            setTimeout(() => firstInput.focus(), 500);
                        }
                    }
                    // Close mobile menu if open
                    if (window.innerWidth < 768) {
                        document.getElementById('sidebar').classList.add('-translate-x-full');
                        document.getElementById('mobile-menu-overlay').classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            }

            // Quick Search button
            const quickSearchButton = document.getElementById('quick-search');
            if (quickSearchButton) {
                quickSearchButton.addEventListener('click', () => {
                    // Focus on search bar
                    const searchBar = document.getElementById('search-bar');
                    if (searchBar) {
                        searchBar.focus();
                        searchBar.select();
                    }
                    // Close mobile menu if open
                    if (window.innerWidth < 768) {
                        document.getElementById('sidebar').classList.add('-translate-x-full');
                        document.getElementById('mobile-menu-overlay').classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            }
        }

        function updateItemsCount() {
            // Update items count badge in sidebar
            const updateCount = () => {
                const itemsContainer = document.getElementById('items-container');
                const itemCards = itemsContainer ? itemsContainer.children.length : 0;
                const badge = document.getElementById('items-count-badge');
                if (badge) {
                    badge.textContent = itemCards;
                    // Add animation when count changes
                    badge.classList.add('animate-pulse');
                    setTimeout(() => badge.classList.remove('animate-pulse'), 1000);
                }
            };

            // Update count initially and whenever items change
            updateCount();
            
            // Watch for changes in items container
            const itemsContainer = document.getElementById('items-container');
            if (itemsContainer) {
                const observer = new MutationObserver(updateCount);
                observer.observe(itemsContainer, { childList: true });
            }
        }
        
        // Image preview functionality
        function loadImagePreview() {
            const imageUrl = document.getElementById('item-image').value.trim();
            const previewContainer = document.getElementById('image-preview-container');
            const previewImg = document.getElementById('image-preview');
            const errorDiv = document.getElementById('image-error');
            
            // Hide error message
            errorDiv.classList.add('hidden');
            
            if (!imageUrl) {
                previewContainer.classList.add('hidden');
                return;
            }
            
            // Show preview container
            previewContainer.classList.remove('hidden');
            
            // Hide previous image while loading
            previewImg.style.display = 'none';
            
            // Test if image loads
            const testImg = new Image();
            testImg.onload = function() {
                previewImg.src = imageUrl;
                previewImg.style.display = 'block';
                errorDiv.classList.add('hidden');
            };
            testImg.onerror = function() {
                previewImg.style.display = 'none';
                errorDiv.classList.remove('hidden');
            };
            testImg.src = imageUrl;
        }
        
        // Update image preview functionality
        function loadUpdateImagePreview() {
            const imageUrl = document.getElementById('update-item-image').value.trim();
            const previewContainer = document.getElementById('update-image-preview-container');
            const previewImg = document.getElementById('update-image-preview');
            const errorDiv = document.getElementById('update-image-error');
            
            // Hide error message
            errorDiv.classList.add('hidden');
            
            if (!imageUrl) {
                previewContainer.classList.add('hidden');
                return;
            }
            
            // Show preview container
            previewContainer.classList.remove('hidden');
            
            // Hide previous image while loading
            previewImg.style.display = 'none';
            
            // Test if image loads
            const testImg = new Image();
            testImg.onload = function() {
                previewImg.src = imageUrl;
                previewImg.style.display = 'block';
                errorDiv.classList.add('hidden');
            };
            testImg.onerror = function() {
                previewImg.style.display = 'none';
                errorDiv.classList.remove('hidden');
            };
            testImg.src = imageUrl;
        }

        // Add debug logging for database connectivity
        console.log('Dashboard initialized - connecting to MySQL database...');
          async function fetchItems() {
            try {
                console.log('Fetching items from MySQL database...');
                updateDatabaseStatus('connecting', 'Connecting...');
                
                const res = await fetch('/api/spareparts');
                
                if (res.ok) {
                    const data = await res.json();                    console.log('Successfully loaded ' + data.length + ' items from database:', data);
                    updateDatabaseStatus('connected', 'MySQL Connected (' + data.length + ' items)');
                    return data;
                } else {
                    console.error('Failed to fetch items - HTTP Status:', res.status);
                    updateDatabaseStatus('error', 'HTTP ' + res.status + ' Error');
                    showDatabaseError('HTTP ' + res.status + ': ' + res.statusText);
                    return [];
                }
            } catch (error) {
                console.error('Failed to fetch items - Network/Database error:', error);
                updateDatabaseStatus('error', 'Connection Failed');
                showDatabaseError(error.message);
                return [];
            }
        }
        
        function updateDatabaseStatus(status, text) {
            const statusDot = document.getElementById('db-status');
            const statusText = document.getElementById('db-status-text');
            
            statusText.textContent = text;
            
            switch(status) {
                case 'connected':
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                    break;
                case 'connecting':
                    statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                    break;
                default:
                    statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
            }
        }
        
        function showDatabaseError(errorMessage) {
            const container = document.getElementById('items-container');
            container.innerHTML = `
                <div class="col-span-full bg-red-50 border-2 border-red-200 rounded-xl p-8 text-center">
                    <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-red-800 mb-2">Database Connection Error</h3>
                    <p class="text-red-600 mb-4">${errorMessage}</p>
                    <div class="text-sm text-red-500">
                        <p>Possible causes:</p>
                        <ul class="list-disc list-inside mt-2">
                            <li>MySQL server is not running</li>
                            <li>Database 'spairparts_db' doesn't exist</li>
                            <li>Connection credentials are incorrect</li>
                            <li>Application backend is not started</li>
                        </ul>
                    </div>
                    <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        üîÑ Retry Connection
                    </button>
                </div>
            `;
        }
        
        function updateStats(items) {
            const totalItems = items.length;
            const totalValue = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const lowStockItems = items.filter(item => item.quantity < 10).length;
            const avgPrice = totalItems > 0 ? totalValue / items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-value').textContent = totalValue.toFixed(2);
            document.getElementById('low-stock').textContent = lowStockItems;
            document.getElementById('avg-price').textContent = avgPrice.toFixed(2);
        }
        
        function updateSearchResults(query, visibleCount, totalCount) {
            // Remove existing search results message
            const existingMessage = document.getElementById('search-results-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Add search results message if there's a search query
            if (query) {
                const itemsContainer = document.getElementById('items-container');
                const message = document.createElement('div');
                message.id = 'search-results-message';
                message.className = 'bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded-lg text-green-700 fade-in';
                message.innerHTML = `üîç Search results for "<strong>${query}</strong>": ${visibleCount} of ${totalCount} items found`;
                itemsContainer.parentNode.insertBefore(message, itemsContainer);
            }
        }
          // Enhanced render function with animations
        function renderItems(items) {
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full bg-blue-50 border-2 border-blue-200 rounded-xl p-8 text-center">
                        <div class="text-blue-600 text-6xl mb-4">üì¶</div>
                        <h3 class="text-xl font-bold text-blue-800 mb-2">No Items Found</h3>
                        <p class="text-blue-600 mb-4">The database is empty or no items match your search.</p>
                        <p class="text-sm text-blue-500">Add some items using the form below to get started!</p>
                    </div>
                `;
                return;
            }
              items.forEach((item, index) => {
                const itemCard = document.createElement('div');
                itemCard.className = 'bg-white rounded-2xl p-6 shadow-xl border border-white/50 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl fade-in';
                itemCard.style.animationDelay = `${index * 0.1}s`;                // Create admin buttons (update and delete) - only visible for admins                const updateButtonHtml = isAdmin ? `
                    <button onclick="openUpdateModal(${item.id}, '${item.name}', '${item.description}', ${item.price}, ${item.quantity}, '${item.currency || 'LKR'}', '${item.image || ''}')" 
                            class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-3 py-1 rounded-lg text-xs font-semibold transition-all duration-300 transform hover:scale-105 mr-2">
                        ‚úèÔ∏è Update
                    </button>
                ` : '';
                
                const deleteButtonHtml = isAdmin ? `
                    <button onclick="deleteItem(${item.id}, '${item.name}')" 
                            class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-3 py-1 rounded-lg text-xs font-semibold transition-all duration-300 transform hover:scale-105">
                        üóëÔ∏è Delete
                    </button>
                ` : '';
                
                // Debug logging for button visibility
                console.log(`Item ${item.id}: isAdmin=${isAdmin}, updateButton=${updateButtonHtml ? 'VISIBLE' : 'HIDDEN'}, deleteButton=${deleteButtonHtml ? 'VISIBLE' : 'HIDDEN'}`);                itemCard.innerHTML = `
                    ${item.image ? `
                        <div class="mb-4">
                            <img src="${item.image}" 
                                 alt="${item.name}" 
                                 class="w-full h-32 object-cover rounded-lg shadow-md"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="hidden bg-gray-200 h-32 rounded-lg flex items-center justify-center text-gray-500">
                                üñºÔ∏è Image unavailable
                            </div>
                        </div>
                    ` : ''}
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-secondary item-name">${item.name}</h3>
                        <div class="flex items-center">
                            <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-semibold item-id">ID: ${item.id}</span>
                            <div class="ml-2 flex items-center">
                                ${updateButtonHtml}
                                ${deleteButtonHtml}
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-600 mb-4 item-description">${item.description}</p>
                    <div class="flex justify-between items-center">
                        <div class="text-2xl font-bold bg-gradient-to-r from-success to-green-600 bg-clip-text text-transparent">
                            ${item.price.toFixed(2)} ${item.currency || 'LKR'}
                        </div>
                        <div class="px-4 py-2 rounded-full text-sm font-bold ${item.quantity < 10 ? 'bg-gradient-to-r from-accent to-red-600 text-white animate-pulse-glow' : 'bg-gradient-to-r from-primary to-blue-600 text-white'}">
                            Qty: ${item.quantity}
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-400">
                        DB ID: ${item.id} | Currency: ${item.currency || 'LKR'} ${isAdmin ? '| Role: ' + userRole : ''}
                    </div>
                `;
                container.appendChild(itemCard);
            });
        }
          async function loadDashboard() {
            console.log('Loading dashboard data from MySQL...');
            const items = await fetchItems();
            updateStats(items);
            renderItems(items);
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            
            // Test database connection
            try {
                const dbStatus = await fetch('/api/test/db-connection');
                if (dbStatus.ok) {
                    const statusData = await dbStatus.json();
                    console.log('Database connection test:', statusData);
                    updateDatabaseStatus('connected', `MySQL Connected (${statusData.totalRecords || 0} items)`);
                }
            } catch (error) {
                console.warn('Database status check failed:', error);
            }
        }
        
        // Load dashboard on page load
        loadDashboard();
        
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);        // Add item form submission
        document.getElementById('add-item-form').addEventListener('submit', async function(e) {
            e.preventDefault();            const name = document.getElementById('item-name').value.trim();
            const description = document.getElementById('item-description').value.trim();
            const price = parseFloat(document.getElementById('item-price').value);
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const currency = document.getElementById('item-currency').value;
            const image = document.getElementById('item-image').value.trim() || null;

            // Validation
            if (!name || !description) {
                alert('‚ö†Ô∏è Please fill in all fields');
                return;
            }
            if (price <= 0) {
                alert('‚ö†Ô∏è Price must be greater than 0');
                return;
            }
            if (quantity <= 0) {
                alert('‚ö†Ô∏è Quantity must be greater than 0');
                return;
            }

            const newItem = { name, description, price, quantity, currency, image };
            
            try {
                console.log('Adding new item to MySQL database:', newItem);
                const response = await fetch('/api/spareparts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newItem)
                });

                if (response.ok) {
                    const savedItem = await response.json();
                    console.log('Item successfully saved to database:', savedItem);
                    alert(`‚úÖ Item "${name}" added successfully to MySQL database!\nDB ID: ${savedItem.id}`);
                    document.getElementById('add-item-form').reset();
                    loadDashboard(); // Refresh the dashboard
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save item:', errorText);
                    alert(`‚ùå Failed to add item to database. Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('Error adding item:', error);
                alert('üö® Database connection error. Please check if MySQL is running.');
            }
        });        // Enhanced Navigation functionality with mobile support
        document.querySelectorAll('.nav-item:not(.logout):not(button)').forEach(item => {
            item.addEventListener('click', function() {
                // Skip if this is a button (quick actions)
                if (this.tagName === 'BUTTON') return;
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item:not(button)').forEach(nav => {
                    nav.classList.remove('active', 'bg-gradient-to-r', 'from-primary', 'to-purple', 'text-white');
                });
                
                // Add active class to clicked item
                this.classList.add('active', 'bg-gradient-to-r', 'from-primary', 'to-purple', 'text-white');
                
                const section = this.getAttribute('data-section');
                console.log(`üìã Navigation: Switching to section '${section}'`);
                
                // Hide all sections first
                const sectionsToHide = ['analytics-section', 'admin-section', 'users-section', 'settings-section'];
                sectionsToHide.forEach(sectionId => {
                    const element = document.getElementById(sectionId);
                    if (element) element.classList.add('hidden');
                });
                
                // Show main content areas
                const mainAreas = document.querySelectorAll('.main-content-area');
                mainAreas.forEach(area => area.classList.remove('hidden'));
                
                // Handle specific sections
                switch(section) {
                    case 'overview':
                        // Show main dashboard content (default view)
                        console.log('üìä Showing overview dashboard');
                        break;
                        
                    case 'items':
                        // Focus on items grid and scroll to it
                        const itemsContainer = document.getElementById('items-container');
                        if (itemsContainer) {
                            itemsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        console.log('üì¶ Focusing on items grid');
                        break;
                        
                    case 'analytics':
                        document.getElementById('analytics-section').classList.remove('hidden');
                        loadAnalytics();
                        console.log('üìà Loading analytics dashboard');
                        break;
                        
                    case 'settings':
                        // TODO: Add settings section
                        console.log('‚öôÔ∏è Settings section (to be implemented)');
                        alert('‚öôÔ∏è Settings panel coming soon!');
                        break;
                        
                    case 'admin':
                        if (isAdmin) {
                            // TODO: Add admin panel
                            console.log('üîê Admin panel (to be implemented)');
                            alert('üîê Admin panel coming soon!');
                        } else {
                            alert('‚ùå Access denied. Admin privileges required.');
                        }
                        break;
                        
                    case 'users':
                        if (isAdmin) {
                            // TODO: Add user management
                            console.log('üë• User management (to be implemented)');
                            alert('üë• User management panel coming soon!');
                        } else {
                            alert('‚ùå Access denied. Admin privileges required.');
                        }
                        break;
                }
                
                // Close mobile menu after navigation (mobile only)
                if (window.innerWidth < 768) {
                    setTimeout(() => {
                        const sidebar = document.getElementById('sidebar');
                        const overlay = document.getElementById('mobile-menu-overlay');
                        if (sidebar) sidebar.classList.add('-translate-x-full');
                        if (overlay) overlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }, 300); // Small delay for better UX
                }
            });
        });

        async function loadAnalytics() {
            const items = await fetchItems();
            generateCharts(items);
            generateInsights(items);
        }

        function generateCharts(items) {
            // Stock Distribution Chart
            const stockCtx = document.getElementById('stockChart').getContext('2d');
            const stockData = items.map(item => ({ name: item.name, quantity: item.quantity }));
            drawBarChart(stockCtx, stockData, 'Quantity');

            // Price Analysis Chart
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            const priceData = items.map(item => ({ name: item.name, value: item.price }));
            drawBarChart(priceCtx, priceData, 'Price');

            // Inventory Trends Chart (simulated data for demonstration)
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            drawTrendChart(trendCtx, items);

            // Reorder Recommendations Chart
            const reorderCtx = document.getElementById('reorderChart').getContext('2d');
            const lowStockItems = items.filter(item => item.quantity < 10);
            drawReorderChart(reorderCtx, lowStockItems);
        }

        function drawBarChart(ctx, data, label) {
            const canvas = ctx.canvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (data.length === 0) {
                ctx.fillStyle = '#3498db';
                ctx.font = '16px Arial';
                ctx.fillText('No data available', canvas.width/2 - 60, canvas.height/2);
                return;
            }
            
            const maxValue = Math.max(...data.map(d => d.value || d.quantity));
            const barWidth = Math.max(20, canvas.width / data.length - 10);
            const barHeight = canvas.height - 40;
            
            data.slice(0, Math.floor(canvas.width / (barWidth + 10))).forEach((item, index) => {
                const value = item.value || item.quantity;
                const height = (value / maxValue) * barHeight;
                const x = index * (barWidth + 10) + 5;
                const y = canvas.height - height - 20;
                
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, barWidth, height);
                
                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Arial';
                ctx.fillText(item.name.substring(0, 8), x, canvas.height - 5);
                ctx.fillText(value.toFixed(1), x, y - 5);
            });
        }

        function drawTrendChart(ctx, items) {
            const canvas = ctx.canvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Simulated trend data for the last 6 months
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const totalValue = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const trendData = months.map((month, index) => totalValue * (0.8 + index * 0.04));
            
            const maxValue = Math.max(...trendData);
            const stepX = canvas.width / (months.length - 1);
            const stepY = (canvas.height - 40) / maxValue;
            
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            trendData.forEach((value, index) => {
                const x = index * stepX;
                const y = canvas.height - (value * stepY) - 20;
                
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                
                // Draw points
                ctx.fillStyle = '#27ae60';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw labels
                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Arial';
                ctx.fillText(months[index], x - 10, canvas.height - 5);
                ctx.fillText(value.toFixed(0), x - 15, y - 10);
            });
            
            ctx.strokeStyle = '#27ae60';
            ctx.stroke();
        }

        function drawReorderChart(ctx, lowStockItems) {
            const canvas = ctx.canvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (lowStockItems.length === 0) {
                ctx.fillStyle = '#27ae60';
                ctx.font = '16px Arial';
                ctx.fillText('All items well stocked!', canvas.width/2 - 80, canvas.height/2);
                return;
            }
            
            const reorderData = lowStockItems.slice(0, 5).map(item => ({
                name: item.name,
                current: item.quantity,
                recommended: Math.max(20, item.quantity * 3)
            }));
            
            const maxValue = Math.max(...reorderData.map(d => d.recommended));
            const barWidth = canvas.width / reorderData.length / 2 - 5;
            
            reorderData.forEach((item, index) => {
                const x = index * (barWidth * 2 + 10) + 5;
                const currentHeight = (item.current / maxValue) * (canvas.height - 40);
                const recommendedHeight = (item.recommended / maxValue) * (canvas.height - 40);
                
                // Current stock (red)
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(x, canvas.height - currentHeight - 20, barWidth, currentHeight);
                
                // Recommended stock (green)
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(x + barWidth, canvas.height - recommendedHeight - 20, barWidth, recommendedHeight);
                
                // Labels
                ctx.fillStyle = '#2c3e50';
                ctx.font = '8px Arial';
                ctx.fillText(item.name.substring(0, 6), x, canvas.height - 5);
            });
        }

        function generateInsights(items) {
            // Critical insights
            const criticalItems = items.filter(item => item.quantity <= 5);
            const criticalContent = criticalItems.length > 0 ? 
                `${criticalItems.length} items critically low: ${criticalItems.map(i => i.name).join(', ')}` :
                'No critical stock issues';
            document.getElementById('critical-content').innerHTML = criticalContent;

            // Warning insights
            const lowStockItems = items.filter(item => item.quantity > 5 && item.quantity < 10);
            const warningContent = lowStockItems.length > 0 ?
                `${lowStockItems.length} items need restocking: ${lowStockItems.map(i => i.name).join(', ')}` :
                'Stock levels are healthy';
            document.getElementById('warning-content').innerHTML = warningContent;

            // Recommendations
            const totalValue = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const avgPrice = totalValue / Math.max(1, items.reduce((sum, item) => sum + item.quantity, 0));
            const highValueItems = items.filter(item => item.price > avgPrice * 1.5);
            const recommendationContent = `
                ‚Ä¢ Consider bulk purchasing for ${criticalItems.length + lowStockItems.length} low-stock items<br>
                ‚Ä¢ High-value items (${highValueItems.length}): Monitor closely for demand patterns<br>
                ‚Ä¢ Total inventory value: $${totalValue.toFixed(2)}
            `;
            document.getElementById('recommendation-content').innerHTML = recommendationContent;            // Forecast
            const forecastContent = `
                ‚Ä¢ Expected reorder cost: ${((criticalItems.length + lowStockItems.length) * avgPrice * 10).toFixed(2)}<br>
                ‚Ä¢ Suggested safety stock: 15 units per item<br>
                ‚Ä¢ Next review date: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}<br>
                ‚Ä¢ Inventory turnover: Estimated 6 months
            `;
            document.getElementById('forecast-content').innerHTML = forecastContent;
        }

        // Search functionality
        function performSearch() {
            const query = document.getElementById('search-bar').value.toLowerCase().trim();
            const items = document.querySelectorAll('#items-container > div');
            let visibleCount = 0;
            
            items.forEach(item => {
                const name = item.querySelector('.item-name').textContent.toLowerCase();
                const description = item.querySelector('.item-description').textContent.toLowerCase();
                const itemId = item.querySelector('.item-id').textContent.toLowerCase();
                
                // Remove previous highlights
                removeHighlights(item);
                
                if (query === '' || name.includes(query) || description.includes(query) || itemId.includes(query)) {
                    item.style.display = '';
                    visibleCount++;
                    
                    // Add highlights if there's a search query
                    if (query) {
                        highlightSearchTerm(item, query);
                    }
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show search results count
            updateSearchResults(query, visibleCount, items.length);
        }
        
        function highlightSearchTerm(item, query) {
            const nameElement = item.querySelector('.item-name');
            const descElement = item.querySelector('.item-description');
            const idElement = item.querySelector('.item-id');
            
            [nameElement, descElement, idElement].forEach(element => {
                if (element && element.textContent.toLowerCase().includes(query)) {
                    const regex = new RegExp(`(${query})`, 'gi');
                    element.innerHTML = element.textContent.replace(regex, '<span class="search-results-highlight">$1</span>');
                }
            });
        }
        
        function removeHighlights(item) {
            const highlightedElements = item.querySelectorAll('.search-results-highlight');
            highlightedElements.forEach(element => {
                const parent = element.parentNode;
                parent.replaceChild(document.createTextNode(element.textContent), element);
                parent.normalize();
            });
        }
        
        function clearSearch() {
            document.getElementById('search-bar').value = '';
            performSearch(); // This will show all items and remove highlights
        }

        // Event listeners for search functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Search button click
            document.getElementById('search-button').addEventListener('click', performSearch);
            
            // Clear button click
            document.getElementById('clear-search-button').addEventListener('click', clearSearch);
            
            // Search on Enter key press
            document.getElementById('search-bar').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // Real-time search as user types
            document.getElementById('search-bar').addEventListener('input', function() {
                // Debounce the search to avoid too many calls
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(performSearch, 300);
            });        });        // Delete item functionality (admin only)
        async function deleteItem(itemId, itemName) {
            console.log(`üóëÔ∏è Delete requested: Item ${itemId} (${itemName}), isAdmin=${isAdmin}`);
            
            if (!isAdmin) {
                alert('‚ùå Access denied. Only administrators can delete items.');
                return;
            }

            if (!confirm(`üóëÔ∏è Are you sure you want to delete "${itemName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                console.log(`Calling DELETE API: /api/spareparts/${itemId}`);
                
                const response = await fetch(`/api/spareparts/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log(`API Response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const message = await response.text();
                    console.log('‚úÖ Delete successful:', message);
                    alert(`‚úÖ "${itemName}" has been deleted successfully!`);
                    loadDashboard(); // Refresh the dashboard
                } else if (response.status === 403) {
                    const errorMessage = await response.text();
                    console.error('‚ùå 403 Forbidden:', errorMessage);
                    alert(`‚ùå Access denied: ${errorMessage}`);
                } else if (response.status === 401) {
                    console.error('‚ùå 401 Unauthorized');
                    alert('‚ùå Authentication required. Please login again.');
                    window.location.href = '/login';
                } else if (response.status === 404) {
                    console.error('‚ùå 404 Not Found');
                    alert('‚ùå Item not found. It may have already been deleted.');
                    loadDashboard(); // Refresh to update the view
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Server error:', errorText);
                    alert(`‚ùå Failed to delete item. Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('üö® Network error:', error);
                alert('üö® Network error. Please check your connection and try again.');
            }        }        // Update item functionality (admin only)
        function openUpdateModal(itemId, itemName, itemDescription, itemPrice, itemQuantity, itemCurrency, itemImage) {
            console.log(`‚úèÔ∏è Update requested: Item ${itemId} (${itemName}), isAdmin=${isAdmin}`);
            
            if (!isAdmin) {
                alert('‚ùå Access denied. Only administrators can update items.');
                return;
            }

            // Populate the modal with current values
            document.getElementById('update-item-id').value = itemId;
            document.getElementById('update-item-name').value = itemName;
            document.getElementById('update-item-description').value = itemDescription;
            document.getElementById('update-item-price').value = itemPrice;
            document.getElementById('update-item-quantity').value = itemQuantity;
            document.getElementById('update-item-currency').value = itemCurrency;
            document.getElementById('update-item-image').value = itemImage || '';

            // Clear previous image preview
            const previewContainer = document.getElementById('update-image-preview-container');
            const previewImg = document.getElementById('update-image-preview');
            previewContainer.classList.add('hidden');
            previewImg.style.display = 'none';

            // Show the modal
            document.getElementById('updateModal').classList.remove('hidden');
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').classList.add('hidden');
            // Clear the form
            document.getElementById('update-item-form').reset();
        }

        async function updateItem(itemId, updatedData) {
            console.log(`üîÑ Updating item ${itemId}:`, updatedData);

            if (!isAdmin) {
                alert('‚ùå Access denied. Only administrators can update items.');
                return;
            }

            try {
                const response = await fetch(`/api/spareparts/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                console.log(`API Response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const updatedItem = await response.json();
                    console.log('‚úÖ Update successful:', updatedItem);
                    alert(`‚úÖ "${updatedData.name}" has been updated successfully!`);
                    closeUpdateModal();
                    loadDashboard(); // Refresh the dashboard
                } else if (response.status === 403) {
                    const errorMessage = await response.text();
                    console.error('‚ùå 403 Forbidden:', errorMessage);
                    alert(`‚ùå Access denied: ${errorMessage}`);
                } else if (response.status === 401) {
                    console.error('‚ùå 401 Unauthorized');
                    alert('‚ùå Authentication required. Please login again.');
                    window.location.href = '/login';
                } else if (response.status === 404) {
                    console.error('‚ùå 404 Not Found');
                    alert('‚ùå Item not found. It may have been deleted.');
                    closeUpdateModal();
                    loadDashboard(); // Refresh to update the view
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Server error:', errorText);
                    alert(`‚ùå Failed to update item. Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('üö® Network error:', error);
                alert('üö® Network error. Please check your connection and try again.');
            }
        }

        // Update form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('update-item-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const itemId = document.getElementById('update-item-id').value;
                const updatedData = {
                    name: document.getElementById('update-item-name').value.trim(),
                    description: document.getElementById('update-item-description').value.trim(),
                    price: parseFloat(document.getElementById('update-item-price').value),
                    quantity: parseInt(document.getElementById('update-item-quantity').value),
                    currency: document.getElementById('update-item-currency').value
                };

                // Validate the data
                if (!updatedData.name || !updatedData.description || isNaN(updatedData.price) || isNaN(updatedData.quantity)) {
                    alert('‚ùå Please fill in all fields with valid values.');
                    return;
                }

                if (updatedData.price < 0 || updatedData.quantity < 0) {
                    alert('‚ùå Price and quantity must be non-negative.');
                    return;
                }

                await updateItem(itemId, updatedData);
            });

            // Close modal when clicking outside
            document.getElementById('updateModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUpdateModal();
                }
            });
        });

        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Create a form to submit POST request for logout
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/logout';
                
                // Add CSRF token if needed
                const csrfToken = document.querySelector('meta[name="_csrf"]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }        }
    </script>

    <!-- Update Item Modal -->
    <div id="updateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-secondary">‚úèÔ∏è Update Spare Part</h2>
                <button onclick="closeUpdateModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">√ó</button>
            </div>
            
            <form id="update-item-form" class="space-y-4">
                <input type="hidden" id="update-item-id">
                
                <input type="text" 
                       id="update-item-name" 
                       placeholder="Item Name" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                
                <textarea id="update-item-description" 
                         placeholder="Item Description" 
                         required 
                         rows="3"
                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300"></textarea>
                
                <input type="number" 
                       id="update-item-price" 
                       placeholder="Price" 
                       step="0.01" 
                       min="0" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                       
                <input type="number" 
                       id="update-item-quantity" 
                       placeholder="Quantity" 
                       min="0" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                  <select id="update-item-currency" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                    <option value="LKR">LKR (Sri Lankan Rupee)</option>
                    <option value="USD">USD (US Dollar)</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="GBP">GBP (British Pound)</option>
                </select>
                
                <div class="flex gap-2">
                    <input type="url" 
                           id="update-item-image" 
                           placeholder="Image URL (optional)" 
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                    <button type="button" 
                            onclick="loadUpdateImagePreview()" 
                            class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold transition-colors duration-300">
                        üñºÔ∏è Preview
                    </button>
                </div>
                
                <!-- Update Image Preview Area -->
                <div id="update-image-preview-container" class="hidden">
                    <div class="bg-gray-50 rounded-xl p-4 text-center">
                        <p class="text-sm text-gray-600 mb-2">Image Preview:</p>
                        <img id="update-image-preview" 
                             src="" 
                             alt="Image preview" 
                             class="max-w-full max-h-32 mx-auto rounded-lg shadow-md"
                             style="display: none;">
                        <div id="update-image-error" class="text-red-500 text-sm hidden">
                            ‚ùå Failed to load image. Please check the URL.
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" 
                            onclick="closeUpdateModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold transition-colors duration-300">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105">
                        Update Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
