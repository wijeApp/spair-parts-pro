<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Spare Parts Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <meta name="_csrf_parameterName" th:content="${_csrf?.parameterName}"/>
    
    <!-- Tailwind CSS for responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db',
                        secondary: '#2c3e50',
                        accent: '#e74c3c',
                        success: '#27ae60',
                        warning: '#f39c12',
                        purple: '#9b59b6'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite'
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulseGlow {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(231, 76, 60, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
        }
        
        /* Responsive layout adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar {
                width: 18rem;
                position: fixed;
                height: 100vh;
            }
            .main-content {
                margin-left: 18rem;
            }
        }
        
        .search-results-highlight {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600">
    <!-- Mobile menu toggle -->
    <div class="md:hidden fixed top-4 left-4 z-50">
        <button id="mobile-menu-toggle" class="bg-white p-2 rounded-lg shadow-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar bg-gradient-to-b from-gray-800 via-gray-900 to-black text-white p-6 shadow-2xl z-40 transform transition-transform duration-300 md:transform-none">
        <div class="mb-8 text-center">
            <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent" 
                th:text="${pageTitle ?: 'Dashboard'}">
                Dashboard
            </h2>
        </div>
        
        <nav class="space-y-3">
            <div class="nav-item active bg-gradient-to-r from-primary to-purple text-white px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg" data-section="overview">
                üìä Overview
            </div>
            <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="items">
                üì¶ Items
            </div>
            <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="analytics">
                üìà Analytics
            </div>
            <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="settings">
                ‚öôÔ∏è Settings
            </div>
            
            <hr class="my-6 border-gray-600">
            
            <div class="nav-item logout bg-gradient-to-r from-accent to-red-600 px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg" onclick="logout()">
                üö™ Logout
            </div>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content min-h-screen p-4 md:p-8 bg-white/95 backdrop-blur-sm overflow-y-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl p-4 md:p-8 mb-8 shadow-xl border border-white/50">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <div class="flex-1">
                    <h1 class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-primary to-purple bg-clip-text text-transparent mb-2">
                        Spare Parts Dashboard
                    </h1>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4 text-sm text-gray-600">
                        <div class="bg-gray-100 px-4 py-2 rounded-full font-semibold">
                            Welcome, <span th:text="${#authentication?.name ?: 'Guest'}">User</span>!
                            <span th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" 
                                  class="ml-2 bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-bold">ADMIN</span>
                        </div>
                        <div>Last Updated: <span id="last-updated" class="font-semibold"></span></div>
                        <div class="flex items-center gap-2">
                            <div id="db-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <span id="db-status-text" class="text-xs">Connecting...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Search Container -->
                <div class="flex flex-col gap-3">
                    <input type="text" 
                           id="search-bar" 
                           placeholder="üîç Search items..."
                           class="px-4 py-3 border-2 border-gray-200 rounded-full focus:border-primary focus:ring-0 focus:outline-none transition-all duration-300 text-sm w-full md:w-80">
                    
                    <div class="flex gap-2 justify-center md:justify-end">
                        <button id="search-button" 
                                class="bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white px-4 py-2 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg text-sm">
                            üîç Search
                        </button>
                        <button id="clear-search-button" 
                                class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-2 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 text-sm">
                            ‚úñ Clear
                        </button>
                        <button class="bg-gradient-to-r from-accent to-red-600 hover:from-red-600 hover:to-accent text-white px-4 py-2 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 text-sm" onclick="logout()">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Total Items</h3>
                <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-primary to-purple bg-clip-text text-transparent" id="total-items">0</div>
            </div>
            <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Total Value</h3>
                <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-success to-green-600 bg-clip-text text-transparent" id="total-value">0</div>
            </div>
            <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Low Stock</h3>
                <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-accent to-red-600 bg-clip-text text-transparent" id="low-stock">0</div>
            </div>
            <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Avg Price</h3>
                <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-warning to-yellow-600 bg-clip-text text-transparent" id="avg-price">0</div>
            </div>
        </div>
        
        <!-- Search Results Message -->
        <div id="search-results-container"></div>
        
        <!-- Items Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8" id="items-container">
            <!-- Server-side rendered items -->
            <div th:each="item : ${spareparts}" 
                 class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg md:text-xl font-bold text-secondary item-name" th:text="${item.name}">Item Name</h3>
                    <div class="flex items-center">
                        <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-semibold item-id" 
                              th:text="'ID: ' + ${item.id}">ID: 0</span>
                        <div class="ml-2 flex items-center" th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">
                            <button th:onclick="'openUpdateModal(' + ${item.id} + ', \'' + ${item.name} + '\', \'' + ${item.description} + '\', ' + ${item.price} + ', ' + ${item.quantity} + ', \'' + ${item.currency ?: 'LKR'} + '\')'"
                                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-2 py-1 rounded-lg text-xs font-semibold transition-all duration-300 transform hover:scale-105 mr-1">
                                ‚úèÔ∏è
                            </button>
                            <button th:onclick="'deleteItem(' + ${item.id} + ', \'' + ${item.name} + '\')'"
                                    class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-2 py-1 rounded-lg text-xs font-semibold transition-all duration-300 transform hover:scale-105">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
                <p class="text-gray-600 mb-4 item-description text-sm md:text-base" th:text="${item.description}">Description</p>
                <div class="flex justify-between items-center">
                    <div class="text-lg md:text-2xl font-bold bg-gradient-to-r from-success to-green-600 bg-clip-text text-transparent">
                        <span th:text="${#numbers.formatDecimal(item.price, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                        <span th:text="${item.currency ?: 'LKR'}">LKR</span>
                    </div>
                    <div th:class="${'px-3 py-1 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-bold ' + (item.quantity < 10 ? 'bg-gradient-to-r from-accent to-red-600 text-white animate-pulse' : 'bg-gradient-to-r from-primary to-blue-600 text-white')}">
                        <span th:text="'Qty: ' + ${item.quantity}">Qty: 0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Item Form -->
        <div class="bg-white rounded-2xl p-4 md:p-8 shadow-xl border border-white/50 mb-8">
            <h2 class="text-xl md:text-2xl font-bold text-center text-secondary mb-6 md:mb-8">üì¶ Add New Item</h2>
            <form th:action="@{/spareparts/add}" method="POST" th:object="${newSparepart}" 
                  class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                
                <div>
                    <input type="text" 
                           th:field="*{name}"
                           placeholder="Item Name" 
                           required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="text-red-500 text-xs block mt-1"></span>
                </div>
                
                <div>
                    <input type="text" 
                           th:field="*{description}"
                           placeholder="Item Description" 
                           required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                    <span th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="text-red-500 text-xs block mt-1"></span>
                </div>
                
                <div>
                    <input type="number" 
                           th:field="*{price}"
                           placeholder="Price" 
                           step="0.01" 
                           min="0" 
                           required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                    <span th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="text-red-500 text-xs block mt-1"></span>
                </div>
                
                <div>
                    <input type="number" 
                           th:field="*{quantity}"
                           placeholder="Quantity" 
                           min="1" 
                           required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                    <span th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}" class="text-red-500 text-xs block mt-1"></span>
                </div>
                
                <div>
                    <select th:field="*{currency}"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                        <option value="LKR">LKR (Sri Lankan Rupee)</option>
                        <option value="USD">USD (US Dollar)</option>
                        <option value="EUR">EUR (Euro)</option>
                        <option value="GBP">GBP (British Pound)</option>
                    </select>
                    <span th:if="${#fields.hasErrors('currency')}" th:errors="*{currency}" class="text-red-500 text-xs block mt-1"></span>
                </div>
                
                <div class="md:col-span-2">
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-success to-green-600 hover:from-green-600 hover:to-success text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                        Add Item to Stock
                    </button>
                </div>
                
                <!-- CSRF Token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </form>
        </div>
    </div>

    <!-- Update Item Modal -->
    <div id="updateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md w-full shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-secondary">‚úèÔ∏è Update Item</h2>
                <button onclick="closeUpdateModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">√ó</button>
            </div>
            
            <form id="update-item-form" class="space-y-4">
                <input type="hidden" id="update-item-id">
                
                <input type="text" 
                       id="update-item-name" 
                       placeholder="Item Name" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                
                <textarea id="update-item-description" 
                         placeholder="Item Description" 
                         required 
                         rows="3"
                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300"></textarea>
                
                <input type="number" 
                       id="update-item-price" 
                       placeholder="Price" 
                       step="0.01" 
                       min="0" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                       
                <input type="number" 
                       id="update-item-quantity" 
                       placeholder="Quantity" 
                       min="0" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                
                <select id="update-item-currency" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                    <option value="LKR">LKR (Sri Lankan Rupee)</option>
                    <option value="USD">USD (US Dollar)</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="GBP">GBP (British Pound)</option>
                </select>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" 
                            onclick="closeUpdateModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold transition-colors duration-300">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105">
                        Update Item
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        // Get authentication info from Thymeleaf safely
        const isAdmin = /*[[${#authorization.expression('hasRole(''ROLE_ADMIN'')')}]]*/ false;
        const currentUser = /*[[${#authentication?.name}]]*/ 'anonymous';
        const csrfToken = /*[[${_csrf?.token}]]*/ '';
        const csrfHeader = /*[[${_csrf?.headerName}]]*/ '';
        
        console.log('User Info:', { isAdmin, currentUser });
        
        // Mobile menu functionality
        document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('mobile-menu-toggle');
            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                sidebar.classList.add('-translate-x-full');
            }
        });
        
        // Database status functions
        function updateDatabaseStatus(status, text) {
            const statusDot = document.getElementById('db-status');
            const statusText = document.getElementById('db-status-text');
            
            statusText.textContent = text;
            
            switch(status) {
                case 'connected':
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                    break;
                case 'connecting':
                    statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                    break;
            }
        }
        
        // Fetch items from API
        async function fetchItems() {
            try {
                updateDatabaseStatus('connecting', 'Connecting...');
                const response = await fetch('/api/spareparts');
                
                if (response.ok) {
                    const data = await response.json();
                    updateDatabaseStatus('connected', `Connected (${data.length} items)`);
                    return data;
                } else {
                    updateDatabaseStatus('error', `Error ${response.status}`);
                    return [];
                }
            } catch (error) {
                updateDatabaseStatus('error', 'Connection Failed');
                return [];
            }
        }
        
        // Update statistics
        function updateStats(items) {
            const totalItems = items.length;
            const totalValue = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const lowStockItems = items.filter(item => item.quantity < 10).length;
            const avgPrice = totalItems > 0 ? totalValue / items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-value').textContent = totalValue.toFixed(2);
            document.getElementById('low-stock').textContent = lowStockItems;
            document.getElementById('avg-price').textContent = avgPrice.toFixed(2);
        }
        
        // Load dashboard data
        async function loadDashboard() {
            const items = await fetchItems();
            updateStats(items);
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }
        
        // Search functionality
        function performSearch() {
            const query = document.getElementById('search-bar').value.toLowerCase().trim();
            const items = document.querySelectorAll('#items-container > div');
            let visibleCount = 0;
            
            items.forEach(item => {
                const name = item.querySelector('.item-name')?.textContent.toLowerCase() || '';
                const description = item.querySelector('.item-description')?.textContent.toLowerCase() || '';
                
                if (query === '' || name.includes(query) || description.includes(query)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function clearSearch() {
            document.getElementById('search-bar').value = '';
            performSearch();
        }
        
        // Admin functions
        function openUpdateModal(itemId, itemName, itemDescription, itemPrice, itemQuantity, itemCurrency) {
            if (!isAdmin) {
                alert('Access denied. Only administrators can update items.');
                return;
            }
            
            document.getElementById('update-item-id').value = itemId;
            document.getElementById('update-item-name').value = itemName;
            document.getElementById('update-item-description').value = itemDescription;
            document.getElementById('update-item-price').value = itemPrice;
            document.getElementById('update-item-quantity').value = itemQuantity;
            document.getElementById('update-item-currency').value = itemCurrency;
            document.getElementById('updateModal').classList.remove('hidden');
        }
        
        function closeUpdateModal() {
            document.getElementById('updateModal').classList.add('hidden');
        }
        
        async function deleteItem(itemId, itemName) {
            if (!isAdmin) {
                alert('Access denied. Only administrators can delete items.');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${itemName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/spareparts/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                });
                
                if (response.ok) {
                    alert(`"${itemName}" has been deleted successfully!`);
                    location.reload();
                } else {
                    alert(`Failed to delete item. Error: ${response.status}`);
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/logout';
                
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Search functionality
            document.getElementById('search-button').addEventListener('click', performSearch);
            document.getElementById('clear-search-button').addEventListener('click', clearSearch);
            document.getElementById('search-bar').addEventListener('input', function() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(performSearch, 300);
            });
            
            // Update form submission
            document.getElementById('update-item-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const itemId = document.getElementById('update-item-id').value;
                const updatedData = {
                    name: document.getElementById('update-item-name').value.trim(),
                    description: document.getElementById('update-item-description').value.trim(),
                    price: parseFloat(document.getElementById('update-item-price').value),
                    quantity: parseInt(document.getElementById('update-item-quantity').value),
                    currency: document.getElementById('update-item-currency').value
                };
                
                try {
                    const response = await fetch(`/api/spareparts/${itemId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(updatedData)
                    });
                    
                    if (response.ok) {
                        alert('Item updated successfully!');
                        closeUpdateModal();
                        location.reload();
                    } else {
                        alert(`Failed to update item. Error: ${response.status}`);
                    }
                } catch (error) {
                    alert('Network error. Please try again.');
                }
            });
        });
        
        // Refresh data every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
