<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Spare Parts Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db',
                        secondary: '#2c3e50',
                        accent: '#e74c3c',
                        success: '#27ae60',
                        warning: '#f39c12',
                        purple: '#9b59b6'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulseGlow {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(231, 76, 60, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .search-results-highlight {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600">
    <!-- Mobile Menu Button -->
    <button id="mobile-menu-button" class="fixed top-4 left-4 z-50 md:hidden bg-gray-800 text-white p-3 rounded-lg shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

    <!-- Main Container -->
    <div class="flex min-h-screen">
        <!-- Responsive Sidebar -->
        <div id="sidebar" class="fixed md:relative transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40 w-72 bg-gradient-to-b from-gray-800 via-gray-900 to-black text-white shadow-2xl h-full overflow-y-auto">
            <div class="p-6">
                <!-- Sidebar Header -->
                <div class="mb-8 text-center relative">
                    <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        Dashboard
                    </h2>
                    <!-- Close button for mobile -->
                    <button id="close-mobile-menu" class="absolute top-0 right-0 md:hidden text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Navigation -->
                <nav class="space-y-3">
                    <div class="nav-item active bg-gradient-to-r from-primary to-purple text-white px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg" data-section="overview">
                        üìä Overview
                    </div>
                    <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="items">
                        üì¶ Items
                    </div>
                    <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="analytics">
                        üìà Analytics
                    </div>
                    <div class="nav-item px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-700 hover:scale-105" data-section="settings">
                        ‚öôÔ∏è Settings
                    </div>
                    
                    <hr class="my-6 border-gray-600">
                    
                    <div class="nav-item logout bg-gradient-to-r from-accent to-red-600 px-4 py-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg" onclick="logout()">
                        üö™ Logout
                    </div>
                </nav>
            </div>
        </div>
        
        <!-- Main Content Area - Responsive -->
        <div class="flex-1 md:ml-0 p-4 md:p-8 bg-white/95 backdrop-blur-sm overflow-y-auto min-h-screen">
            <!-- Header - Mobile Responsive -->
            <div class="bg-white rounded-2xl p-4 md:p-8 mb-6 md:mb-8 shadow-xl border border-white/50">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div class="mb-6 lg:mb-0">
                        <h1 class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-primary to-purple bg-clip-text text-transparent mb-2">
                            Spare Parts Dashboard
                        </h1>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4 text-sm text-gray-600">
                            <div class="bg-gray-100 px-4 py-2 rounded-full font-semibold">
                                Welcome, <span id="username-display" th:text="${username ?: 'User'}">User</span>!
                                <span th:if="${isAdmin}" class="ml-2 bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-bold">ADMIN</span>
                            </div>
                            <div>Last Updated: <span id="last-updated" class="font-semibold"></span></div>
                            <div class="flex items-center gap-2">
                                <div id="db-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                                <span id="db-status-text" class="text-xs">Connecting...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Container - Mobile Responsive -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" 
                               id="search-bar" 
                               placeholder="üîç Search items by name, description, or ID..."
                               class="px-4 md:px-6 py-3 border-2 border-gray-200 rounded-full focus:border-primary focus:ring-0 focus:outline-none transition-all duration-300 text-sm w-full sm:w-80">
                        
                        <div class="flex gap-2">
                            <button id="search-button" 
                                    class="bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white px-4 md:px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl text-sm">
                                üîç <span class="hidden sm:inline">Search</span>
                            </button>
                            <button id="clear-search-button" 
                                    class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 md:px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 text-sm">
                                ‚úñ <span class="hidden sm:inline">Clear</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>              <!-- Stats Grid - Responsive with Server-Side Values -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Total Items</h3>
                    <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-primary to-purple bg-clip-text text-transparent" id="total-items" 
                         th:text="${dashboardStats != null ? dashboardStats.totalItems : (spareparts != null ? #lists.size(spareparts) : 0)}">0</div>
                </div>
                <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Total Value</h3>
                    <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-success to-green-600 bg-clip-text text-transparent" id="total-value">
                        <span th:if="${dashboardStats != null}" th:text="${dashboardStats.formattedTotalValue}">0.00</span>
                        <span th:if="${dashboardStats == null and spareparts != null and not #lists.isEmpty(spareparts)}" 
                              th:text="${#numbers.formatDecimal(#aggregates.sum(spareparts.![price * quantity]), 1, 2)}">0.00</span>
                        <span th:if="${dashboardStats == null and (spareparts == null or #lists.isEmpty(spareparts))}">0.00</span>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Low Stock Items</h3>
                    <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-accent to-red-600 bg-clip-text text-transparent" id="low-stock">
                        <span th:if="${dashboardStats != null}" th:text="${dashboardStats.lowStockItems}">0</span>
                        <span th:if="${dashboardStats == null and spareparts != null and not #lists.isEmpty(spareparts)}" 
                              th:text="${#lists.size(spareparts.?[quantity lt 10])}">0</span>
                        <span th:if="${dashboardStats == null and (spareparts == null or #lists.isEmpty(spareparts))}">0</span>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <h3 class="text-xs md:text-sm font-bold text-gray-600 uppercase tracking-wider mb-2 md:mb-4">Average Price</h3>
                    <div class="text-2xl md:text-4xl font-black bg-gradient-to-r from-warning to-yellow-600 bg-clip-text text-transparent" id="avg-price">
                        <span th:if="${dashboardStats != null}" th:text="${dashboardStats.formattedAveragePrice}">0.00</span>
                        <span th:if="${dashboardStats == null and spareparts != null and not #lists.isEmpty(spareparts)}" 
                              th:text="${#numbers.formatDecimal(#aggregates.avg(spareparts.![price]), 1, 2)}">0.00</span>
                        <span th:if="${dashboardStats == null and (spareparts == null or #lists.isEmpty(spareparts))}">0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Search Results Message -->
            <div id="search-results-container"></div>
            
            <!-- Items Grid with Thymeleaf Server-Side Rendering - Responsive -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8" id="items-container">
                <!-- Server-side rendered items using Thymeleaf -->
                <div th:if="${spareparts != null and not #lists.isEmpty(spareparts)}" 
                     th:each="item : ${spareparts}" 
                     class="bg-white rounded-2xl p-4 md:p-6 shadow-xl border border-white/50 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4 gap-2">
                        <h3 th:text="${item.name}" class="text-lg md:text-xl font-bold text-secondary leading-tight">Item Name</h3>
                        <div class="flex flex-col sm:items-end gap-2">
                            <div class="flex items-center">
                                <span th:text="${item.currency ?: 'LKR'}" class="text-xs text-gray-500 mr-1">LKR</span>
                                <span th:text="${#numbers.formatDecimal(item.price, 1, 2)}" class="text-xl md:text-2xl font-bold text-primary">0.00</span>
                            </div>
                            <div class="bg-gray-100 px-2 py-1 rounded-full text-xs font-semibold text-gray-700">
                                Stock: <span th:text="${item.quantity}">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <p th:text="${item.description}" class="text-gray-600 mb-4 text-sm">Description</p>                    <!-- Image preview section -->
                    <div class="mb-4 flex justify-center">
                        <div th:if="${item.imagePath != null and item.imagePath != ''}" class="relative">
                            <img th:src="@{'/uploads/' + ${item.imagePath}}" 
                                 th:alt="${item.name}"
                                 class="w-full h-48 object-cover rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300"
                                 onerror="console.error('Image failed to load:', this.src); this.parentElement.innerHTML='<div class=\'w-full h-48 bg-red-100 border border-red-300 rounded-lg flex items-center justify-center\'><span class=\'text-red-600\'>‚ùå Image Load Failed<br><small>Path: ' + this.getAttribute('th:src') + '</small></span></div>'">
                        </div>
                        <div th:unless="${item.imagePath != null and item.imagePath != ''}" 
                             class="w-full h-48 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex items-center justify-center">
                            <span class="text-gray-500 text-lg">üì¶ No Image</span>
                        </div>
                    </div>
                    
                    <!-- Admin buttons using Spring Security - Mobile Responsive -->
                    <div class="flex flex-col sm:flex-row gap-2" sec:authorize="hasRole('ADMIN')">
                        <button th:onclick="'openUpdateModal(' + ${item.id} + ', \'' + ${item.name} + '\', \'' + ${item.description} + '\', ' + ${item.price} + ', ' + ${item.quantity} + ', \'' + ${item.currency ?: 'LKR'} + '\')'"
                                class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-3 py-2 rounded-lg text-xs font-semibold transition-all duration-300 transform hover:scale-105">
                            ‚úèÔ∏è Update
                        </button>
                        <button th:onclick="'deleteItem(' + ${item.id} + ', \'' + ${item.name} + '\')'"
                                class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-3 py-2 rounded-lg text-xs font-semibold transition-all duration-300 transform hover:scale-105">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
                
                <!-- Empty state when no items -->
                <div th:if="${spareparts == null or #lists.isEmpty(spareparts)}" 
                     class="col-span-full bg-blue-50 border-2 border-blue-200 rounded-xl p-6 md:p-8 text-center">
                    <div class="text-blue-600 text-4xl md:text-6xl mb-4">üì¶</div>
                    <h3 class="text-lg md:text-xl font-bold text-blue-800 mb-2">No Items Found</h3>
                    <p class="text-blue-600 mb-4">The database is empty or no items match your search.</p>
                    <p class="text-sm text-blue-500">Add some items using the form below to get started!</p>
                </div>
            </div>
            
            <!-- Add Item Form with Thymeleaf - Mobile Responsive -->
            <div class="bg-white rounded-2xl p-4 md:p-8 shadow-xl border border-white/50 mb-6 md:mb-8" sec:authorize="hasRole('ADMIN')">
                <h2 class="text-lg md:text-2xl font-bold text-center text-secondary mb-6">üì¶ Add New Item to Stock</h2>
                
                <!-- Display validation errors -->
                <div th:if="${#fields.hasAnyErrors()}" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
                    <strong>Please fix the following errors:</strong>
                    <ul class="mt-2 list-disc list-inside">
                        <li th:each="error : ${#fields.allErrors()}" th:text="${error}">Error message</li>
                    </ul>
                </div>
                
                <form th:action="@{/spareparts/add}" th:object="${newSparepart}" method="post" 
                      class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    
                    <!-- CSRF token -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    
                    <div class="relative">
                        <input type="text" 
                               th:field="*{name}"
                               placeholder="Item Name" 
                               required 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300"
                               th:classappend="${#fields.hasErrors('name')} ? 'border-red-500' : ''">
                        <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    
                    <div class="relative">
                        <input type="text" 
                               th:field="*{description}"
                               placeholder="Item Description" 
                               required 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300"
                               th:classappend="${#fields.hasErrors('description')} ? 'border-red-500' : ''">
                        <span th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    
                    <div class="relative">
                        <input type="number" 
                               th:field="*{price}"
                               placeholder="Price" 
                               step="0.01" 
                               min="0" 
                               required 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300"
                               th:classappend="${#fields.hasErrors('price')} ? 'border-red-500' : ''">
                        <span th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    
                    <div class="relative">
                        <input type="number" 
                               th:field="*{quantity}"
                               placeholder="Quantity" 
                               min="1" 
                               required 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300"
                               th:classappend="${#fields.hasErrors('quantity')} ? 'border-red-500' : ''">
                        <span th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    
                    <div class="relative md:col-span-2">
                        <select th:field="*{currency}" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-success focus:ring-0 focus:outline-none transition-colors duration-300">
                            <option value="LKR">LKR (Sri Lankan Rupee)</option>
                            <option value="USD">USD (US Dollar)</option>
                            <option value="EUR">EUR (Euro)</option>
                            <option value="GBP">GBP (British Pound)</option>
                        </select>
                    </div>
                    
                    <button type="submit" 
                            class="md:col-span-2 bg-gradient-to-r from-success to-green-600 hover:from-green-600 hover:to-success text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                        Add Item to Stock
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Update Item Modal - Mobile Responsive -->
    <div id="updateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-secondary">‚úèÔ∏è Update Item</h2>
                <button onclick="closeUpdateModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">√ó</button>
            </div>
            
            <form id="update-item-form" class="space-y-4">
                <input type="hidden" id="update-item-id">
                
                <input type="text" 
                       id="update-item-name" 
                       placeholder="Item Name" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                
                <textarea id="update-item-description" 
                         placeholder="Item Description" 
                         required 
                         rows="3"
                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300"></textarea>
                
                <input type="number" 
                       id="update-item-price" 
                       placeholder="Price" 
                       step="0.01" 
                       min="0" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                       
                <input type="number" 
                       id="update-item-quantity" 
                       placeholder="Quantity" 
                       min="0" 
                       required 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                
                <select id="update-item-currency" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 focus:outline-none transition-colors duration-300">
                    <option value="LKR">LKR (Sri Lankan Rupee)</option>
                    <option value="USD">USD (US Dollar)</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="GBP">GBP (British Pound)</option>
                </select>
                
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 pt-4">
                    <button type="button" 
                            onclick="closeUpdateModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-bold transition-colors duration-300">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105">
                        Update Item
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        // Store admin status from server
        const isAdmin = /*[[${isAdmin}]]*/ false;
        const currentUser = /*[[${username}]]*/ 'User';
        const userRole = /*[[${userRole}]]*/ 'USER';
        
        console.log('Dashboard initialized with user info:', { isAdmin, currentUser, userRole });

        // Mobile Menu Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            const closeMobileMenu = document.getElementById('close-mobile-menu');

            function openMobileMenu() {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeMobileMenuFunc() {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', openMobileMenu);
            }

            if (closeMobileMenu) {
                closeMobileMenu.addEventListener('click', closeMobileMenuFunc);
            }

            if (overlay) {
                overlay.addEventListener('click', closeMobileMenuFunc);
            }

            // Close mobile menu when nav item is clicked
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth < 768) { // Only on mobile
                        closeMobileMenuFunc();
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    closeMobileMenuFunc();
                }
            });            // Initialize dashboard
            initializeDashboard();
            
            // Refresh data every 30 seconds
            setInterval(loadDashboard, 30000);
        });        function initializeDashboard() {
            // Update last updated time
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = new Date().toLocaleString();
            }
            
            // Debug the DOM structure for troubleshooting
            setTimeout(debugItemStructure, 100);
            
            // Calculate initial statistics from server-side rendered data
            calculateInitialStats();
            
            // Set database status
            updateDatabaseStatus('connecting', 'Connecting...');
            
            // Initialize search functionality
            initializeSearch();
            
            // Initialize navigation
            initializeNavigation();
            
            // Setup dynamic updates
            setupDynamicUpdates();
            
            // Load dashboard data and update statistics from API
            loadDashboard();
        }function updateDatabaseStatus(status, text) {
            const statusDot = document.getElementById('db-status');
            const statusText = document.getElementById('db-status-text');
            
            if (statusText) statusText.textContent = text;
            
            if (statusDot) {
                switch(status) {
                    case 'connected':
                        statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                        break;
                    case 'connecting':
                        statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                        break;
                    case 'error':
                        statusDot.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                        break;
                    default:
                        statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                }
            }
        }

        // Fetch items from API
        async function fetchItems() {
            try {
                console.log('Fetching items from MySQL database...');
                updateDatabaseStatus('connecting', 'Connecting...');
                
                const response = await fetch('/api/spareparts');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`Successfully loaded ${data.length} items from database:`, data);
                    updateDatabaseStatus('connected', `Connected (${data.length} items)`);
                    return data;
                } else {
                    console.error('Failed to fetch items - HTTP Status:', response.status);
                    updateDatabaseStatus('error', `HTTP ${response.status} Error`);
                    return [];
                }
            } catch (error) {
                console.error('Failed to fetch items - Network/Database error:', error);
                updateDatabaseStatus('error', 'Connection Failed');
                return [];
            }
        }        // Update statistics
        function updateStats(items) {
            const totalItems = items.length;
            const totalValue = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const lowStockItems = items.filter(item => item.quantity < 10).length;
            const avgPrice = totalItems > 0 ? totalValue / items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            
            console.log('Updating statistics:', { totalItems, totalValue, lowStockItems, avgPrice });
            
            // Update DOM elements
            const totalItemsEl = document.getElementById('total-items');
            const totalValueEl = document.getElementById('total-value');
            const lowStockEl = document.getElementById('low-stock');
            const avgPriceEl = document.getElementById('avg-price');
            
            if (totalItemsEl) totalItemsEl.textContent = totalItems;
            if (totalValueEl) totalValueEl.textContent = totalValue.toFixed(2);
            if (lowStockEl) lowStockEl.textContent = lowStockItems;
            if (avgPriceEl) avgPriceEl.textContent = avgPrice.toFixed(2);
        }

        // Refresh statistics from API
        async function refreshStatisticsFromAPI() {
            console.log('Refreshing statistics from API...');
            try {
                const response = await fetch('/api/spareparts/statistics');
                if (response.ok) {
                    const stats = await response.json();
                    console.log('API Statistics received:', stats);
                    
                    // Update DOM elements with API data
                    const totalItemsEl = document.getElementById('total-items');
                    const totalValueEl = document.getElementById('total-value');
                    const lowStockEl = document.getElementById('low-stock');
                    const avgPriceEl = document.getElementById('avg-price');
                    
                    if (totalItemsEl) totalItemsEl.textContent = stats.totalItems || 0;
                    if (totalValueEl) totalValueEl.textContent = stats.formattedTotalValue || '0.00';
                    if (lowStockEl) lowStockEl.textContent = stats.lowStockItems || 0;
                    if (avgPriceEl) avgPriceEl.textContent = stats.formattedAveragePrice || '0.00';
                    
                    console.log('‚úÖ Statistics updated successfully from API');
                    updateDatabaseStatus('connected', `Stats Updated (${stats.lastUpdated})`);
                } else {
                    console.error('Failed to fetch statistics from API:', response.status);
                    updateDatabaseStatus('error', 'Stats API Error');
                }
            } catch (error) {
                console.error('Error refreshing statistics from API:', error);
                updateDatabaseStatus('error', 'Stats API Failed');
            }        }// Load dashboard data
        async function loadDashboard() {
            console.log('Loading dashboard data from MySQL...');
            const items = await fetchItems();
            updateStats(items);
            
            // Also refresh statistics from API for most accurate data
            await refreshStatisticsFromAPI();
            
            // Update last updated time
            const lastUpdatedEl = document.getElementById('last-updated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = new Date().toLocaleString();
            }
        }        // Calculate initial statistics from server-side rendered data
        function calculateInitialStats() {
            console.log('Calculating initial statistics from server-side data...');
            
            // Get all item cards from the items container
            const itemElements = document.querySelectorAll('#items-container > div');
            
            console.log(`Found ${itemElements.length} total divs in items container`);
            
            if (itemElements.length === 0) {
                console.log('No server-side items found, will rely on API data');
                return;
            }

            let totalItems = 0;
            let totalValue = 0;
            let lowStockItems = 0;
            let totalQuantity = 0;

            itemElements.forEach((item, index) => {
                // Skip empty state div and any hidden items
                if (item.textContent.includes('No Items Found') || 
                    item.classList.contains('col-span-full') ||
                    item.style.display === 'none') {
                    console.log(`Skipping item ${index + 1}: Empty state or hidden`);
                    return;
                }
                  // More precise selectors based on the actual HTML structure
                // Price span has classes: "text-xl md:text-2xl font-bold text-primary"
                const priceEl = item.querySelector('span[class*="text-xl"][class*="font-bold"][class*="text-primary"]') ||
                              item.querySelector('span[class*="text-2xl"][class*="font-bold"][class*="text-primary"]') ||
                              item.querySelector('span.text-xl.font-bold.text-primary');
                
                // Stock container has classes: "bg-gray-100 px-2 py-1 rounded-full text-xs font-semibold text-gray-700"
                const stockDiv = item.querySelector('div[class*="bg-gray-100"][class*="px-2"][class*="py-1"][class*="rounded-full"]') ||
                               item.querySelector('div[class*="bg-gray-100"][class*="rounded-full"]');
                
                // Quantity is the span inside the stock div
                const quantityEl = stockDiv ? stockDiv.querySelector('span') : null;
                  console.log(`Processing item ${index + 1}:`, {
                    hasItem: !!item,
                    itemClasses: Array.from(item.classList),
                    priceEl: priceEl ? {
                        text: priceEl.textContent.trim(),
                        classes: Array.from(priceEl.classList),
                        parent: priceEl.parentElement ? Array.from(priceEl.parentElement.classList) : 'no parent'
                    } : 'NOT FOUND',
                    stockDiv: stockDiv ? {
                        text: stockDiv.textContent.trim(),
                        classes: Array.from(stockDiv.classList),
                        innerHTML: stockDiv.innerHTML
                    } : 'NOT FOUND',
                    quantityEl: quantityEl ? {
                        text: quantityEl.textContent.trim(),
                        classes: Array.from(quantityEl.classList)
                    } : 'NOT FOUND'
                });
                  if (priceEl && quantityEl) {
                    const priceText = priceEl.textContent.trim();
                    const quantityText = quantityEl.textContent.trim();
                    
                    // Extract price number (remove currency symbols and spaces)
                    const price = parseFloat(priceText.replace(/[^\d.-]/g, '')) || 0;
                    
                    // Extract quantity number
                    const quantity = parseInt(quantityText) || 0;
                    
                    console.log(`Successfully extracted from item ${index + 1}:`, { 
                        price, 
                        quantity, 
                        priceText, 
                        quantityText 
                    });
                    
                    if (price >= 0 && quantity >= 0) {
                        totalItems++;
                        totalValue += price * quantity;
                        totalQuantity += quantity;
                        
                        if (quantity < 10) {
                            lowStockItems++;
                        }
                    }
                } else {
                    console.warn(`Could not find price or quantity elements in item ${index + 1}`);
                    
                    // Try fallback method - search text content directly
                    const itemText = item.textContent;
                    const priceMatch = itemText.match(/(\d+\.\d{2})/);
                    const stockMatch = itemText.match(/Stock:\s*(\d+)/);
                    
                    if (priceMatch && stockMatch) {
                        const price = parseFloat(priceMatch[1]) || 0;
                        const quantity = parseInt(stockMatch[1]) || 0;
                        
                        console.log(`Fallback extraction successful for item ${index + 1}:`, { price, quantity });
                        
                        if (price >= 0 && quantity >= 0) {
                            totalItems++;
                            totalValue += price * quantity;
                            totalQuantity += quantity;
                            
                            if (quantity < 10) {
                                lowStockItems++;
                            }
                        }
                    } else {
                        console.log(`Fallback extraction failed for item ${index + 1}. Text content:`, itemText.substring(0, 200));
                        
                        // Last resort - look for any spans with numbers
                        const allSpans = item.querySelectorAll('span');
                        console.log(`Found ${allSpans.length} spans:`, 
                            Array.from(allSpans).map(span => ({
                                text: span.textContent.trim(),
                                classes: Array.from(span.classList)
                            }))
                        );
                    }
                }
            });

            const avgPrice = totalQuantity > 0 ? totalValue / totalQuantity : 0;

            console.log('Final calculated statistics:', { 
                totalItems, 
                totalValue: totalValue.toFixed(2), 
                lowStockItems, 
                avgPrice: avgPrice.toFixed(2),
                totalQuantity
            });

            // Update DOM with initial statistics
            const totalItemsEl = document.getElementById('total-items');
            const totalValueEl = document.getElementById('total-value');
            const lowStockEl = document.getElementById('low-stock');
            const avgPriceEl = document.getElementById('avg-price');
            
            if (totalItemsEl) {
                totalItemsEl.textContent = totalItems;
                // Store original count for search functionality
                totalItemsEl.setAttribute('data-original', totalItems);
            }
            if (totalValueEl) totalValueEl.textContent = totalValue.toFixed(2);
            if (lowStockEl) lowStockEl.textContent = lowStockItems;
            if (avgPriceEl) avgPriceEl.textContent = avgPrice.toFixed(2);
            
            // If we didn't find any items, try alternative approach
            if (totalItems === 0) {
                console.log('No items found with primary method, trying alternative approach...');
                calculateInitialStatsAlternative();
            }
        }        // Alternative method to calculate stats if the primary method fails
        function calculateInitialStatsAlternative() {
            console.log('Using alternative calculation method...');
            
            // Count all divs that look like item cards (have the item structure)
            const allDivs = document.querySelectorAll('#items-container > div');
            let alternativeCount = 0;
            let alternativeValue = 0;
            let alternativeLowStock = 0;
            let alternativeQuantity = 0;
            
            allDivs.forEach((div, index) => {
                // Check if this div contains item-like content
                const hasItemName = div.querySelector('h3[class*="text-lg"], h3[class*="text-xl"]');
                const priceMatch = div.textContent.match(/(\d+\.\d{2})/);
                const stockMatch = div.textContent.match(/Stock:\s*(\d+)/);
                
                console.log(`Alternative check item ${index + 1}:`, {
                    hasItemName: !!hasItemName,
                    itemNameText: hasItemName ? hasItemName.textContent.trim() : 'not found',
                    priceMatch: priceMatch ? priceMatch[1] : 'not found',
                    stockMatch: stockMatch ? stockMatch[1] : 'not found',
                    isEmptyState: div.textContent.includes('No Items Found'),
                    fullText: div.textContent.substring(0, 100) + '...'
                });
                
                if (hasItemName && priceMatch && stockMatch && !div.textContent.includes('No Items Found')) {
                    const price = parseFloat(priceMatch[1]) || 0;
                    const quantity = parseInt(stockMatch[1]) || 0;
                    
                    alternativeCount++;
                    alternativeValue += price * quantity;
                    alternativeQuantity += quantity;
                    
                    if (quantity < 10) {
                        alternativeLowStock++;
                    }
                    
                    console.log(`Alternative method found item ${alternativeCount}:`, { 
                        name: hasItemName.textContent.trim(),
                        price, 
                        quantity 
                    });
                }
            });
            
            const alternativeAvgPrice = alternativeQuantity > 0 ? alternativeValue / alternativeQuantity : 0;
            
            console.log(`Alternative method results:`, { 
                alternativeCount, 
                alternativeValue: alternativeValue.toFixed(2), 
                alternativeLowStock, 
                alternativeAvgPrice: alternativeAvgPrice.toFixed(2) 
            });
            
            if (alternativeCount > 0) {
                const totalItemsEl = document.getElementById('total-items');
                const totalValueEl = document.getElementById('total-value');
                const lowStockEl = document.getElementById('low-stock');
                const avgPriceEl = document.getElementById('avg-price');
                
                if (totalItemsEl) {
                    totalItemsEl.textContent = alternativeCount;
                    totalItemsEl.setAttribute('data-original', alternativeCount);
                }
                if (totalValueEl) totalValueEl.textContent = alternativeValue.toFixed(2);
                if (lowStockEl) lowStockEl.textContent = alternativeLowStock;
                if (avgPriceEl) avgPriceEl.textContent = alternativeAvgPrice.toFixed(2);
                
                console.log('‚úÖ Alternative method successfully updated statistics!');
            } else {
                console.log('‚ùå Alternative method also failed to find items');
            }
        }

        function initializeSearch() {
            const searchButton = document.getElementById('search-button');
            const clearButton = document.getElementById('clear-search-button');
            const searchBar = document.getElementById('search-bar');

            if (searchButton) {
                searchButton.addEventListener('click', performSearch);
            }

            if (clearButton) {
                clearButton.addEventListener('click', clearSearch);
            }

            if (searchBar) {
                searchBar.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        }

        function initializeNavigation() {
            // Navigation functionality remains the same
        }        function performSearch() {
            const query = document.getElementById('search-bar').value.toLowerCase().trim();
            // Use the same selector as calculateInitialStats
            const items = document.querySelectorAll('#items-container > div');
            let visibleCount = 0;
            
            items.forEach(item => {
                // Skip empty state div and col-span-full divs
                if (item.textContent.includes('No Items Found') || 
                    item.classList.contains('col-span-full')) {
                    return;
                }
                
                const itemText = item.textContent.toLowerCase();
                const isVisible = query === '' || itemText.includes(query);
                
                if (isVisible) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update total items display to show visible count during search
            const totalItemsEl = document.getElementById('total-items');
            if (totalItemsEl) {
                if (query) {
                    totalItemsEl.textContent = visibleCount;
                    totalItemsEl.setAttribute('data-original', totalItemsEl.getAttribute('data-original') || totalItemsEl.textContent);
                } else {
                    // Restore original count when search is cleared
                    const originalCount = totalItemsEl.getAttribute('data-original');
                    if (originalCount) {
                        totalItemsEl.textContent = originalCount;
                    } else {
                        totalItemsEl.textContent = visibleCount;
                    }
                }
            }
            
            // Update search results message
            const container = document.getElementById('search-results-container');
            if (container) {
                if (query && visibleCount === 0) {
                    container.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg mb-6">
                            <strong>No results found for "${query}"</strong> - Try a different search term or clear the search.
                        </div>
                    `;
                } else if (query && visibleCount > 0) {
                    container.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg mb-6">
                            <strong>Found ${visibleCount} item(s)</strong> matching "${query}"
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                }
            }
        }function clearSearch() {
            document.getElementById('search-bar').value = '';
            performSearch();
        }        // Function to dynamically update statistics when items are modified
        function refreshStatistics() {
            console.log('Refreshing statistics from current DOM state...');
            calculateInitialStats();
        }        // Manual count function as fallback
        function getVisibleItemCount() {
            const items = document.querySelectorAll('#items-container > div');
            let count = 0;
            items.forEach(item => {
                // Skip empty state, col-span-full divs and hidden items
                if (!item.textContent.includes('No Items Found') && 
                    !item.classList.contains('col-span-full') &&
                    item.style.display !== 'none') {
                    count++;
                }
            });
            return count;
        }        // Enhanced update statistics function
        function updateTotalItemsDisplay() {
            const visibleCount = getVisibleItemCount();
            const totalItemsEl = document.getElementById('total-items');
            if (totalItemsEl) {
                totalItemsEl.textContent = visibleCount;
                console.log(`Updated total items display to: ${visibleCount}`);
            }
        }        // Debug function to inspect the DOM structure
        function debugItemStructure() {
            console.log('=== DEBUG: Analyzing item structure ===');
            const items = document.querySelectorAll('#items-container > div');
            
            console.log(`Found ${items.length} total divs in #items-container`);
            
            items.forEach((item, index) => {
                const hasNoItemsText = item.textContent.includes('No Items Found');
                const isColSpanFull = item.classList.contains('col-span-full');
                
                if (hasNoItemsText || isColSpanFull) {
                    console.log(`Item ${index}: SKIPPED (${hasNoItemsText ? 'No Items Found' : 'col-span-full'})`);
                    return;
                }
                
                // Look for all possible price elements
                const priceSelectors = [
                    'span[class*="text-xl"][class*="font-bold"][class*="text-primary"]',
                    'span[class*="text-2xl"][class*="font-bold"][class*="text-primary"]',
                    'span.text-xl.font-bold.text-primary',
                    'span[class*="font-bold"][class*="text-primary"]'
                ];
                
                const stockSelectors = [
                    'div[class*="bg-gray-100"][class*="px-2"][class*="py-1"][class*="rounded-full"]',
                    'div[class*="bg-gray-100"][class*="rounded-full"]',
                    'div:contains("Stock:")',
                    '[class*="stock" i]'
                ];
                
                console.log(`=== Item ${index + 1} Analysis ===`);
                console.log('Classes:', Array.from(item.classList));
                console.log('Text preview:', item.textContent.substring(0, 150) + '...');
                
                // Test each price selector
                priceSelectors.forEach((selector, i) => {
                    const el = item.querySelector(selector);
                    console.log(`Price selector ${i + 1} (${selector}):`, el ? {
                        text: el.textContent.trim(),
                        classes: Array.from(el.classList)
                    } : 'NOT FOUND');
                });
                
                // Test each stock selector
                stockSelectors.forEach((selector, i) => {
                    const el = item.querySelector(selector);
                    console.log(`Stock selector ${i + 1} (${selector}):`, el ? {
                        text: el.textContent.trim(),
                        classes: Array.from(el.classList),
                        innerHTML: el.innerHTML
                    } : 'NOT FOUND');
                });
                
                // Text-based extraction
                const priceMatch = item.textContent.match(/(\d+\.\d{2})/);
                const stockMatch = item.textContent.match(/Stock:\s*(\d+)/);
                console.log('Text extraction:', {
                    priceMatch: priceMatch ? priceMatch[1] : 'not found',
                    stockMatch: stockMatch ? stockMatch[1] : 'not found'
                });
                
                console.log('---');
            });
            
            console.log('=== End Debug Analysis ===');
        }        // Function to add event listeners for dynamic updates
        function setupDynamicUpdates() {
            // Listen for form submissions to refresh stats
            const addItemForm = document.querySelector('form[th\\:action*="add"]');
            if (addItemForm) {
                addItemForm.addEventListener('submit', function() {
                    // Delay refresh to allow server response, then refresh both methods
                    setTimeout(() => {
                        refreshStatistics();
                        refreshStatisticsFromAPI();
                    }, 1000);
                });
            }            // Listen for modal form submissions
            const updateForm = document.getElementById('update-item-form');
            if (updateForm) {
                updateForm.addEventListener('submit', function() {
                    setTimeout(() => {
                        refreshStatistics();
                        refreshStatisticsFromAPI();
                    }, 1000);
                });
            }
        }

        // Update modal functions
        function openUpdateModal(itemId, itemName, itemDescription, itemPrice, itemQuantity, itemCurrency) {
            if (!isAdmin) {
                alert('‚ùå Access denied. Only administrators can update items.');
                return;
            }

            document.getElementById('update-item-id').value = itemId;
            document.getElementById('update-item-name').value = itemName;
            document.getElementById('update-item-description').value = itemDescription;
            document.getElementById('update-item-price').value = itemPrice;
            document.getElementById('update-item-quantity').value = itemQuantity;
            document.getElementById('update-item-currency').value = itemCurrency;

            document.getElementById('updateModal').classList.remove('hidden');
        }        function closeUpdateModal() {
            document.getElementById('updateModal').classList.add('hidden');
            document.getElementById('update-item-form').reset();
        }

        // Add form submission handler for update modal
        document.addEventListener('DOMContentLoaded', function() {
            const updateForm = document.getElementById('update-item-form');
            if (updateForm) {
                updateForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Here you would implement the actual update API call
                    console.log('Update form submitted');
                    
                    // Close modal
                    closeUpdateModal();
                    
                    // Refresh statistics
                    setTimeout(refreshStatistics, 500);
                });
            }
        });

        // Delete function
        function deleteItem(itemId, itemName) {
            if (!isAdmin) {
                alert('‚ùå Access denied. Only administrators can delete items.');
                return;
            }

            if (!confirm(`üóëÔ∏è Are you sure you want to delete "${itemName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            // Implementation would call the backend API here
            console.log(`Deleting item ${itemId}: ${itemName}`);
        }

        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/logout';
                
                const csrfToken = document.querySelector('meta[name="_csrf"]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>
